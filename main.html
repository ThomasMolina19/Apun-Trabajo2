<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan de Desarrollo de Decanatura – Encuesta Institucional</title>
  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --primary-dark: #1e3a8a;
      --success: #16a34a;
      --warning: #ea580c;
      --danger: #dc2626;
      --bg: #f8fafc;
      --surface: #ffffff;
      --surface-hover: #f1f5f9;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --border-hover: #cbd5e1;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
      --radius: 8px;
      --radius-lg: 12px;
    }

    * { 
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
      line-height: 1.6;
      color: var(--text);
    }

    .bg-pattern {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
      position: relative;
      z-index: 1;
    }

    .main-card {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }

    .header h1 {
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .header p {
      opacity: 0.9;
      font-size: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .content {
      padding: 32px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--surface-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.primary {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white;
      border: none;
    }

    .btn.primary:hover {
      box-shadow: var(--shadow-lg);
      filter: brightness(1.1);
    }

    .btn.success {
      background: var(--success);
      color: white;
      border: none;
    }

    .btn.danger {
      background: var(--danger);
      color: white;
      border: none;
    }

    .btn.small {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .progress-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .progress-bar-wrapper {
      background: var(--surface-hover);
      height: 8px;
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-light) 0%, var(--primary) 100%);
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      color: var(--text-muted);
    }

    .stepper {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 0;
      margin-bottom: 24px;
      scrollbar-width: thin;
    }

    .step-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      background: var(--surface);
      border: 2px solid var(--border);
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .step-chip:hover {
      border-color: var(--primary-light);
      color: var(--primary);
    }

    .step-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .step-chip .step-number {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      font-size: 12px;
      font-weight: 700;
    }

    .step-chip.active .step-number {
      background: rgba(255,255,255,0.3);
    }

    .section {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .section h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section h2::before {
      content: '';
      width: 4px;
      height: 24px;
      background: var(--primary);
      border-radius: 2px;
    }

    .help-text {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 20px;
      background: var(--surface-hover);
      padding: 12px 16px;
      border-radius: var(--radius);
      border-left: 4px solid var(--primary-light);
    }

    .grid {
      display: grid;
      gap: 20px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .grid.three {
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--text);
    }

    input, textarea, select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      transition: all 0.2s ease;
      background: var(--surface);
      color: var(--text);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface-hover);
      border-radius: var(--radius);
      margin-bottom: 20px;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
      cursor: pointer;
    }

    .priority-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .priority-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
      transition: all 0.2s ease;
      cursor: move;
    }

    .priority-item:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow-sm);
    }

    .priority-item.dragging {
      opacity: 0.5;
    }

    .priority-handle {
      color: var(--text-muted);
      font-size: 20px;
      cursor: grab;
    }

    .priority-handle:active {
      cursor: grabbing;
    }

    .priority-number {
      background: var(--primary);
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .initiative-card, .kpi-card {
      background: var(--surface-hover);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .score-badge {
      background: linear-gradient(135deg, var(--success) 0%, #22c55e 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
    }

    .range-group {
      background: var(--surface);
      padding: 16px;
      border-radius: var(--radius);
      margin-bottom: 12px;
    }

    .range-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .range-value {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
    }

    input[type="range"] {
      width: 100%;
      padding: 0;
      height: 6px;
      background: var(--surface-hover);
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
      box-shadow: var(--shadow-sm);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }

    .summary-card {
      background: linear-gradient(135deg, var(--surface) 0%, var(--surface-hover) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    .summary-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--primary-dark);
    }

    .nav-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--success);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      font-weight: 500;
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }

    @keyframes slideIn {
      from {
        transform: translateY(100px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .toolbar {
        flex-direction: column;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }

      .grid.two,
      .grid.three {
        grid-template-columns: 1fr;
      }
    }

    @media print {
      body {
        background: white;
      }

      .no-print {
        display: none !important;
      }

      .main-card {
        box-shadow: none;
      }

      .section {
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="bg-pattern"></div>
  
  <div class="container">
    <div class="main-card">
      <div class="header">
        <h1>📋 Plan de Desarrollo de Decanatura</h1>
        <p>Herramienta de recolección de insumos para la planeación estratégica institucional</p>
      </div>

      <div class="content">
        <div class="toolbar no-print">
          <button id="exportBtn" class="btn">
            <span>⬇</span> Exportar JSON
          </button>
          <label class="btn">
            <span>⬆</span> Importar JSON
            <input id="importInput" type="file" accept="application/json" hidden>
          </label>
          <button id="printBtn" class="btn">
            <span>🖨</span> Imprimir PDF
          </button>
          <div style="flex: 1;"></div>
          <button id="resetBtn" class="btn danger">
            <span>⚠</span> Reiniciar
          </button>
        </div>

        <div class="progress-container">
          <div class="progress-bar-wrapper">
            <div id="progressBar" class="progress-bar" style="width: 0%"></div>
          </div>
          <div class="progress-info">
            <span id="progressText">0% completado</span>
            <span>Guardado automático: <span id="lastSaved">—</span></span>
          </div>
        </div>

        <div class="stepper no-print" id="stepper"></div>

        <!-- Paso 1: Bienvenida -->
        <section class="section" data-step="intro">
          <h2>Bienvenida</h2>
          <div class="help-text">
            <p><strong>Objetivo:</strong> Recolectar información valiosa para construir colaborativamente el Plan de Desarrollo de la Decanatura.</p>
            <ul style="margin-top: 12px; margin-left: 20px;">
              <li>⏱ Tiempo estimado: 10-15 minutos</li>
              <li>💾 Guardado automático en tu navegador</li>
              <li>🔒 Opción de respuesta anónima</li>
              <li>📊 Exportación de resultados en JSON o PDF</li>
            </ul>
          </div>
          <div class="nav-buttons no-print">
            <span></span>
            <button class="btn primary" data-next>
              Comenzar <span>→</span>
            </button>
          </div>
        </section>

        <!-- Paso 2: Perfil -->
        <section class="section hidden" data-step="perfil">
          <h2>Perfil del Participante</h2>
          
          <div class="checkbox-group">
            <input type="checkbox" id="anon">
            <label for="anon" style="margin: 0; cursor: pointer;">Prefiero responder de forma anónima</label>
          </div>

          <div id="perfilFields" class="grid two">
            <div class="form-group">
              <label>Nombre completo</label>
              <input data-path="perfil.nombre" placeholder="Ingrese su nombre completo">
            </div>
            <div class="form-group">
              <label>Correo electrónico</label>
              <input type="email" data-path="perfil.email" placeholder="correo@universidad.edu">
            </div>
            <div class="form-group">
              <label>Rol en la institución</label>
              <select data-path="perfil.rol">
                <option value="">Seleccione una opción</option>
                <option>Docente de planta</option>
                <option>Docente catedrático</option>
                <option>Estudiante pregrado</option>
                <option>Estudiante posgrado</option>
                <option>Personal administrativo</option>
                <option>Investigador</option>
                <option>Egresado</option>
              </select>
            </div>
            <div class="form-group">
              <label>Unidad académica / Programa</label>
              <input data-path="perfil.unidad" placeholder="Ej: Departamento de Ingeniería">
            </div>
          </div>

          <div class="nav-buttons no-print">
            <button class="btn" data-prev>
              <span>←</span> Anterior
            </button>
            <button class="btn primary" data-next>
              Siguiente <span>→</span>
            </button>
          </div>
        </section>

        <!-- Paso 3: Diagnóstico FODA -->
        <section class="section hidden" data-step="diagnostico">
          <h2>Diagnóstico Estratégico (FODA)</h2>
          <p class="help-text">
            Ayúdenos a identificar los aspectos clave de nuestra situación actual. Sea específico y constructivo en sus aportes.
          </p>
          
          <div class="grid two">
            <div class="form-group">
              <label>🎯 Fortalezas</label>
              <textarea data-path="diagnostico.fortalezas" placeholder="¿Qué hacemos bien? ¿Cuáles son nuestras ventajas competitivas?"></textarea>
            </div>
            <div class="form-group">
              <label>⚠️ Debilidades</label>
              <textarea data-path="diagnostico.debilidades" placeholder="¿Qué podemos mejorar? ¿Dónde tenemos brechas?"></textarea>
            </div>
            <div class="form-group">
              <label>💡 Oportunidades</label>
              <textarea data-path="diagnostico.oportunidades" placeholder="¿Qué tendencias podemos aprovechar? ¿Qué alianzas podemos formar?"></textarea>
            </div>
            <div class="form-group">
              <label>🚨 Amenazas</label>
              <textarea data-path="diagnostico.amenazas" placeholder="¿Qué riesgos enfrentamos? ¿Qué factores externos nos afectan?"></textarea>
            </div>
          </div>

          <div class="nav-buttons no-print">
            <button class="btn" data-prev>
              <span>←</span> Anterior
            </button>
            <button class="btn primary" data-next>
              Siguiente <span>→</span>
            </button>
          </div>
        </section>

        <!-- Paso 4: Priorización -->
        <section class="section hidden" data-step="prioridades">
          <h2>Priorización Estratégica</h2>
          <p class="help-text">
            Ordene las siguientes áreas según su importancia para el desarrollo de la facultad. Puede arrastrar los elementos o usar los botones de control.
          </p>
          
          <ul id="rankList" class="priority-list"></ul>
          
          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <input id="newPriorityText" placeholder="Agregar nueva prioridad">
            <button id="addPriorityBtn" class="btn primary small">+ Agregar</button>
          </div>

          <div class="form-group" style="margin-top: 24px;">
            <label>Justificación de la priorización</label>
            <textarea data-path="prioridades.comentarios" placeholder="Explique brevemente el razonamiento detrás de su priorización"></textarea>
          </div>

          <div class="nav-buttons no-print">
            <button class="btn" data-prev>
              <span>←</span> Anterior
            </button>
            <button class="btn primary" data-next>
              Siguiente <span>→</span>
            </button>
          </div>
        </section>

        <!-- Paso 5: Iniciativas -->
        <section class="section hidden" data-step="iniciativas">
          <h2>Iniciativas Estratégicas</h2>
          <p class="help-text">
            Proponga iniciativas concretas para el desarrollo de la facultad. Evalúe cada una según su impacto potencial, esfuerzo requerido y alcance.
          </p>
          
          <div id="iniciativasWrap"></div>
          
          <button id="addIni" class="btn primary" style="margin-top: 20px;">
            <span>+</span> Agregar nueva iniciativa
          </button>

          <div class="nav-buttons no-print">
            <button class="btn" data-prev>
              <span>←</span> Anterior
            </button>
            <button class="btn primary" data-next>
              Siguiente <span>→</span>
            </button>
          </div>
        </section>

        <!-- Paso 6: KPIs -->
        <section class="section hidden" data-step="kpis">
          <h2>Indicadores Clave (KPIs)</h2>
          <p class="help-text">
            Define indicadores medibles que nos permitan evaluar el progreso hacia nuestros objetivos estratégicos.
          </p>
          
          <div id="kpisWrap"></div>
          
          <button id="addKpi" class="btn primary" style="margin-top: 20px;">
            <span>+</span> Agregar nuevo KPI
          </button>

          <div class="nav-buttons no-print">
            <button class="btn" data-prev>
              <span>←</span> Anterior
            </button>
            <button class="btn primary" data-next>
              Siguiente <span>→</span>
            </button>
          </div>
        </section>

        <!-- Paso 7: Revisión -->
        <section class="section hidden" data-step="revision">
          <h2>Revisión Final</h2>
          <p class="help-text">
            Por favor revise su información antes de enviar. Puede volver a cualquier sección para hacer cambios.
          </p>
          
          <div id="resumen" class="summary-grid"></div>
          
          <div class="form-group" style="margin-top: 24px;">
            <label>Comentarios adicionales</label>
            <textarea data-path="feedback.comentarios" placeholder="¿Hay algo más que debamos considerar?"></textarea>
          </div>

          <div class="checkbox-group">
            <input type="checkbox" id="consentChk">
            <label for="consentChk" style="margin: 0; cursor: pointer;">
              Autorizo el uso de mis respuestas para fines de planeación institucional
            </label>
          </div>

          <div class="nav-buttons no-print">
            <button class="btn" data-prev>
              <span>←</span> Anterior
            </button>
            <button class="btn success" id="finalExport">
              <span>✓</span> Finalizar y exportar
            </button>
          </div>
        </section>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden">
    <span>✓</span> Guardado automáticamente
  </div>

  <script>
  (function(){
    const STORAGE_KEY = 'pdd-form-v2';
    const DEFAULT_PRIORITIES = [
      { id: 'docencia', label: 'Excelencia en Docencia y Currículo' },
      { id: 'investigacion', label: 'Investigación e Innovación' },
      { id: 'bienestar', label: 'Bienestar Estudiantil y Permanencia' },
      { id: 'internacionalizacion', label: 'Internacionalización y Movilidad' },
      { id: 'infraestructura', label: 'Infraestructura y Recursos' },
      { id: 'transformacion', label: 'Transformación Digital' },
      { id: 'extension', label: 'Extensión y Proyección Social' },
      { id: 'sostenibilidad', label: 'Sostenibilidad y Responsabilidad Social' }
    ];

    const initialState = {
      perfil: { nombre:'', email:'', rol:'', unidad:'', anonimato:false },
      diagnostico: { fortalezas:'', debilidades:'', oportunidades:'', amenazas:'' },
      prioridades: { ranking: [...DEFAULT_PRIORITIES], comentarios:'' },
      iniciativas: [newIni()],
      kpis: [newKpi()],
      feedback: { comentarios:'', consentimiento:false },
    };

    function newIni(){
      return { 
        titulo:'', 
        descripcion:'', 
        impacto:3, 
        esfuerzo:3, 
        alcance:3, 
        plazo: new Date().getFullYear() + 2, 
        responsable:'', 
        presupuesto:'' 
      };
    }

    function newKpi(){
      return { 
        nombre:'', 
        unidad:'', 
        lineaBase:'', 
        objetivo:'', 
        frecuencia:'Trimestral' 
      };
    }

    let state = loadState();
    let stepIdx = 0;
    const steps = ['intro','perfil','diagnostico','prioridades','iniciativas','kpis','revision'];

    // DOM refs
    const stepper = document.getElementById('stepper');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const lastSavedEl = document.getElementById('lastSaved');
    const toast = document.getElementById('toast');
    const exportBtn = document.getElementById('exportBtn');
    const importInput = document.getElementById('importInput');
    const printBtn = document.getElementById('printBtn');
    const resetBtn = document.getElementById('resetBtn');
    const finalExport = document.getElementById('finalExport');

    // Build stepper
    function renderStepper(){
      stepper.innerHTML = '';
      steps.forEach((k, i) => {
        const chip = document.createElement('div');
        chip.className = 'step-chip ' + (i === stepIdx ? 'active' : '');
        chip.innerHTML = `<span class="step-number">${i + 1}</span> ${titleOf(k)}`;
        chip.addEventListener('click', () => goTo(i));
        stepper.appendChild(chip);
      });
    }

    function titleOf(k){
      return {
        intro: 'Inicio',
        perfil: 'Perfil',
        diagnostico: 'Diagnóstico',
        prioridades: 'Priorización',
        iniciativas: 'Iniciativas',
        kpis: 'Indicadores',
        revision: 'Revisión'
      }[k] || k;
    }

    function goTo(i){
      stepIdx = Math.max(0, Math.min(steps.length - 1, i));
      document.querySelectorAll('section[data-step]').forEach(sec => {
        sec.classList.toggle('hidden', steps[stepIdx] !== sec.getAttribute('data-step'));
      });
      renderStepper();
      updateProgress();
      
      if(steps[stepIdx] === 'perfil') syncPerfilUI();
      if(steps[stepIdx] === 'prioridades') renderRank();
      if(steps[stepIdx] === 'iniciativas') renderInis();
      if(steps[stepIdx] === 'kpis') renderKpis();
      if(steps[stepIdx] === 'revision') renderResumen();
      
      window.scrollTo(0, 0);
    }

    // Navigation
    document.querySelectorAll('[data-next]').forEach(b => {
      b.addEventListener('click', () => goTo(stepIdx + 1));
    });
    document.querySelectorAll('[data-prev]').forEach(b => {
      b.addEventListener('click', () => goTo(stepIdx - 1));
    });

    // Profile anonymity toggle
    const anonChk = document.getElementById('anon');
    anonChk.addEventListener('change', () => {
      state.perfil.anonimato = anonChk.checked;
      saveState();
      syncPerfilUI();
    });

    function syncPerfilUI(){
      anonChk.checked = !!state.perfil.anonimato;
      document.getElementById('perfilFields').style.display = state.perfil.anonimato ? 'none' : 'grid';
      
      document.querySelectorAll('[data-path^="perfil."]').forEach(inp => {
        const val = getByPath(state, inp.dataset.path);
        setInputValue(inp, val);
      });
    }

    // Generic input handler
    document.body.addEventListener('input', (e) => {
      const t = e.target;
      if(!t || !t.dataset || !t.dataset.path) return;
      
      let val = t.type === 'number' ? Number(t.value) : t.value;
      setByPath(state, t.dataset.path, val);
      saveState();
    });

    document.body.addEventListener('change', (e) => {
      const t = e.target;
      if(t && t.id === 'consentChk'){
        state.feedback.consentimiento = t.checked;
        saveState();
      }
    });

    // Priority ranking
    const rankList = document.getElementById('rankList');
    const addPriorityBtn = document.getElementById('addPriorityBtn');
    const newPriorityText = document.getElementById('newPriorityText');
    
    addPriorityBtn.addEventListener('click', () => {
      const txt = newPriorityText.value.trim();
      if(!txt) return;
      
      newPriorityText.value = '';
      state.prioridades.ranking.push({ id: uid(), label: txt });
      saveState();
      renderRank();
    });

    function renderRank(){
      rankList.innerHTML = '';
      state.prioridades.ranking.forEach((item, i) => {
        const li = document.createElement('li');
        li.className = 'priority-item';
        li.draggable = true;
        li.innerHTML = `
          <span class="priority-handle">☰</span>
          <span class="priority-number">${i + 1}</span>
          <input style="flex: 1; border: none; background: transparent; font-weight: 500;" 
                 value="${escapeHtml(item.label)}" data-idx="${i}" />
          <button class="btn small" data-up="${i}" title="Subir">↑</button>
          <button class="btn small" data-down="${i}" title="Bajar">↓</button>
          <button class="btn small danger" data-del="${i}" title="Eliminar">×</button>
        `;
        
        // Edit handler
        li.querySelector('input').addEventListener('input', (e) => {
          state.prioridades.ranking[i].label = e.target.value;
          saveState();
        });
        
        // Button handlers
        li.querySelector('[data-up]').addEventListener('click', () => moveRank(i, -1));
        li.querySelector('[data-down]').addEventListener('click', () => moveRank(i, 1));
        li.querySelector('[data-del]').addEventListener('click', () => delRank(i));
        
        // Drag and drop
        li.addEventListener('dragstart', (ev) => {
          ev.dataTransfer.setData('text/plain', i.toString());
          li.classList.add('dragging');
        });
        
        li.addEventListener('dragend', () => {
          li.classList.remove('dragging');
        });
        
        li.addEventListener('dragover', (ev) => {
          ev.preventDefault();
          li.style.borderColor = 'var(--primary-light)';
        });
        
        li.addEventListener('dragleave', () => {
          li.style.borderColor = 'var(--border)';
        });
        
        li.addEventListener('drop', (ev) => {
          ev.preventDefault();
          li.style.borderColor = 'var(--border)';
          
          const from = Number(ev.dataTransfer.getData('text/plain'));
          const to = i;
          
          if(isFinite(from) && from !== to){
            const arr = state.prioridades.ranking;
            const [moved] = arr.splice(from, 1);
            arr.splice(to, 0, moved);
            saveState();
            renderRank();
          }
        });
        
        rankList.appendChild(li);
      });
    }

    function moveRank(i, dir){
      const j = i + dir;
      const arr = state.prioridades.ranking;
      if(j < 0 || j >= arr.length) return;
      
      [arr[i], arr[j]] = [arr[j], arr[i]];
      saveState();
      renderRank();
    }

    function delRank(i){
      if(state.prioridades.ranking.length <= 3){
        alert('Debe mantener al menos 3 prioridades');
        return;
      }
      if(confirm('¿Eliminar esta prioridad?')){
        state.prioridades.ranking.splice(i, 1);
        saveState();
        renderRank();
      }
    }

    // Initiatives
    const inisWrap = document.getElementById('iniciativasWrap');
    document.getElementById('addIni').addEventListener('click', () => {
      state.iniciativas.push(newIni());
      saveState();
      renderInis();
    });

    function renderInis(){
      inisWrap.innerHTML = '';
      state.iniciativas.forEach((it, i) => {
        const score = ((num(it.impacto) * num(it.alcance)) / (num(it.esfuerzo) + 0.5)).toFixed(2);
        const div = document.createElement('div');
        div.className = 'initiative-card';
        div.innerHTML = `
          <div class="card-header">
            <h3 style="margin: 0;">Iniciativa #${i + 1}</h3>
            <div style="display: flex; gap: 12px; align-items: center;">
              <span class="score-badge">Prioridad: ${score}</span>
              <button class="btn small danger" data-del-ini="${i}">Eliminar</button>
            </div>
          </div>
          <div class="grid two">
            <div class="form-group">
              <label>Título de la iniciativa</label>
              <input data-path="iniciativas.${i}.titulo" value="${escapeHtml(it.titulo)}" 
                     placeholder="Ej: Modernización de laboratorios">
            </div>
            <div class="form-group">
              <label>Responsable propuesto</label>
              <input data-path="iniciativas.${i}.responsable" value="${escapeHtml(it.responsable)}" 
                     placeholder="Departamento o persona">
            </div>
          </div>
          <div class="form-group">
            <label>Descripción detallada</label>
            <textarea data-path="iniciativas.${i}.descripcion" 
                      placeholder="Describa el objetivo, alcance y beneficios esperados">${escapeHtml(it.descripcion)}</textarea>
          </div>
          <div class="grid three">
            <div class="range-group">
              <div class="range-label">
                <span>Impacto</span>
                <span class="range-value">${it.impacto}</span>
              </div>
              <input type="range" min="1" max="5" value="${it.impacto}" 
                     data-path="iniciativas.${i}.impacto"
                     oninput="this.parentElement.querySelector('.range-value').textContent=this.value">
            </div>
            <div class="range-group">
              <div class="range-label">
                <span>Esfuerzo</span>
                <span class="range-value">${it.esfuerzo}</span>
              </div>
              <input type="range" min="1" max="5" value="${it.esfuerzo}" 
                     data-path="iniciativas.${i}.esfuerzo"
                     oninput="this.parentElement.querySelector('.range-value').textContent=this.value">
            </div>
            <div class="range-group">
              <div class="range-label">
                <span>Alcance</span>
                <span class="range-value">${it.alcance}</span>
              </div>
              <input type="range" min="1" max="5" value="${it.alcance}" 
                     data-path="iniciativas.${i}.alcance"
                     oninput="this.parentElement.querySelector('.range-value').textContent=this.value">
            </div>
          </div>
          <div class="grid two">
            <div class="form-group">
              <label>Plazo de implementación</label>
              <select data-path="iniciativas.${i}.plazo">${yearOpts(it.plazo)}</select>
            </div>
            <div class="form-group">
              <label>Presupuesto estimado (COP)</label>
              <input data-path="iniciativas.${i}.presupuesto" value="${escapeHtml(it.presupuesto)}" 
                     placeholder="Ej: $50.000.000">
            </div>
          </div>
        `;
        
        div.querySelector('[data-del-ini]').addEventListener('click', () => {
          if(confirm('¿Eliminar esta iniciativa?')){
            state.iniciativas.splice(i, 1);
            if(state.iniciativas.length === 0) state.iniciativas.push(newIni());
            saveState();
            renderInis();
          }
        });
        
        inisWrap.appendChild(div);
      });
    }

    function yearOpts(sel){
      const currentYear = new Date().getFullYear();
      let options = '';
      for(let i = 0; i < 6; i++){
        const year = currentYear + i;
        options += `<option ${sel == year ? 'selected' : ''}>${year}</option>`;
      }
      return options;
    }

    // KPIs
    const kpisWrap = document.getElementById('kpisWrap');
    document.getElementById('addKpi').addEventListener('click', () => {
      state.kpis.push(newKpi());
      saveState();
      renderKpis();
    });

    function renderKpis(){
      kpisWrap.innerHTML = '';
      state.kpis.forEach((k, i) => {
        const div = document.createElement('div');
        div.className = 'kpi-card';
        div.innerHTML = `
          <div class="card-header">
            <h3 style="margin: 0;">KPI #${i + 1}</h3>
            <button class="btn small danger" data-del-kpi="${i}">Eliminar</button>
          </div>
          <div class="grid two">
            <div class="form-group">
              <label>Nombre del indicador</label>
              <input data-path="kpis.${i}.nombre" value="${escapeHtml(k.nombre)}" 
                     placeholder="Ej: Tasa de graduación oportuna">
            </div>
            <div class="form-group">
              <label>Unidad de medida</label>
              <input data-path="kpis.${i}.unidad" value="${escapeHtml(k.unidad)}" 
                     placeholder="Ej: %, número, índice">
            </div>
            <div class="form-group">
              <label>Línea base actual</label>
              <input data-path="kpis.${i}.lineaBase" value="${escapeHtml(k.lineaBase)}" 
                     placeholder="Valor actual del indicador">
            </div>
            <div class="form-group">
              <label>Meta objetivo</label>
              <input data-path="kpis.${i}.objetivo" value="${escapeHtml(k.objetivo)}" 
                     placeholder="Valor esperado">
            </div>
            <div class="form-group">
              <label>Frecuencia de medición</label>
              <select data-path="kpis.${i}.frecuencia">
                ${['Mensual','Bimestral','Trimestral','Semestral','Anual'].map(f => 
                  `<option ${k.frecuencia === f ? 'selected' : ''}>${f}</option>`
                ).join('')}
              </select>
            </div>
          </div>
        `;
        
        div.querySelector('[data-del-kpi]').addEventListener('click', () => {
          if(confirm('¿Eliminar este KPI?')){
            state.kpis.splice(i, 1);
            if(state.kpis.length === 0) state.kpis.push(newKpi());
            saveState();
            renderKpis();
          }
        });
        
        kpisWrap.appendChild(div);
      });
    }

    // Summary
    function renderResumen(){
      const resumen = document.getElementById('resumen');
      
      const priorities = state.prioridades.ranking
        .map((p, i) => `<li><strong>${i + 1}.</strong> ${escapeHtml(p.label)}</li>`)
        .join('');
      
      const initiatives = state.iniciativas
        .filter(x => x.titulo)
        .map(x => `<li><strong>${escapeHtml(x.titulo)}</strong> - Plazo: ${x.plazo}</li>`)
        .join('');
      
      const kpis = state.kpis
        .filter(k => k.nombre)
        .map(k => `<li><strong>${escapeHtml(k.nombre)}</strong> - Meta: ${escapeHtml(k.objetivo || 'Por definir')}</li>`)
        .join('');
      
      resumen.innerHTML = `
        <div class="summary-card">
          <h3>👤 Información del participante</h3>
          ${state.perfil.anonimato ? 
            '<p style="color: var(--text-muted);">Respuesta anónima</p>' : 
            `<p><strong>Nombre:</strong> ${escapeHtml(state.perfil.nombre || '—')}<br>
             <strong>Email:</strong> ${escapeHtml(state.perfil.email || '—')}<br>
             <strong>Rol:</strong> ${escapeHtml(state.perfil.rol || '—')}<br>
             <strong>Unidad:</strong> ${escapeHtml(state.perfil.unidad || '—')}</p>`
          }
        </div>
        
        <div class="summary-card">
          <h3>📊 Análisis FODA</h3>
          <p style="font-size: 14px;">
            <strong>Fortalezas:</strong> ${state.diagnostico.fortalezas ? '✓ Completado' : '⚠ Pendiente'}<br>
            <strong>Debilidades:</strong> ${state.diagnostico.debilidades ? '✓ Completado' : '⚠ Pendiente'}<br>
            <strong>Oportunidades:</strong> ${state.diagnostico.oportunidades ? '✓ Completado' : '⚠ Pendiente'}<br>
            <strong>Amenazas:</strong> ${state.diagnostico.amenazas ? '✓ Completado' : '⚠ Pendiente'}
          </p>
        </div>
        
        <div class="summary-card">
          <h3>🎯 Prioridades estratégicas</h3>
          <ol style="margin: 0; padding-left: 20px; font-size: 14px;">
            ${priorities || '<li>No definidas</li>'}
          </ol>
        </div>
        
        <div class="summary-card">
          <h3>💡 Iniciativas propuestas</h3>
          <ul style="margin: 0; padding-left: 20px; font-size: 14px; list-style: none;">
            ${initiatives || '<li>No hay iniciativas definidas</li>'}
          </ul>
        </div>
        
        <div class="summary-card">
          <h3>📈 Indicadores (KPIs)</h3>
          <ul style="margin: 0; padding-left: 20px; font-size: 14px; list-style: none;">
            ${kpis || '<li>No hay KPIs definidos</li>'}
          </ul>
        </div>
      `;
      
      document.getElementById('consentChk').checked = !!state.feedback.consentimiento;
    }

    // Utility functions
    function getByPath(obj, path){
      return path.split('.').reduce((o, k) => o ? o[k] : undefined, obj);
    }

    function setByPath(obj, path, val){
      const parts = path.split('.');
      let current = obj;
      for(let i = 0; i < parts.length - 1; i++){
        current = current[parts[i]];
      }
      current[parts[parts.length - 1]] = val;
    }

    function setInputValue(el, v){
      if(el.tagName === 'SELECT' || el.tagName === 'INPUT' || el.tagName === 'TEXTAREA'){
        el.value = v ?? '';
      }
    }

    function loadState(){
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if(!stored) return structuredClone(initialState);
        return migrate(JSON.parse(stored));
      } catch(e) {
        console.error('Error loading state:', e);
        return structuredClone(initialState);
      }
    }

    function migrate(s){
      // Ensure all required fields exist
      s.perfil = s.perfil || structuredClone(initialState.perfil);
      s.diagnostico = s.diagnostico || structuredClone(initialState.diagnostico);
      s.prioridades = s.prioridades || structuredClone(initialState.prioridades);
      
      if(!s.prioridades.ranking || !s.prioridades.ranking.length){
        s.prioridades.ranking = [...DEFAULT_PRIORITIES];
      }
      
      s.iniciativas = Array.isArray(s.iniciativas) && s.iniciativas.length ? 
                      s.iniciativas : [newIni()];
      s.kpis = Array.isArray(s.kpis) && s.kpis.length ? 
               s.kpis : [newKpi()];
      s.feedback = s.feedback || structuredClone(initialState.feedback);
      
      return s;
    }

    function saveState(){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        showSaved();
        updateProgress();
      } catch(e) {
        console.error('Error saving state:', e);
      }
    }

    function showSaved(){
      const now = new Date();
      lastSavedEl.textContent = now.toLocaleTimeString('es-CO', {
        hour: '2-digit',
        minute: '2-digit'
      });
      
      toast.classList.remove('hidden');
      clearTimeout(showSaved._timer);
      showSaved._timer = setTimeout(() => {
        toast.classList.add('hidden');
      }, 2000);
    }

    function updateProgress(){
      let completed = 0;
      let total = 0;
      
      // Profile section
      if(state.perfil.anonimato){
        total += 1;
        completed += 1;
      } else {
        total += 4;
        if(state.perfil.nombre) completed++;
        if(state.perfil.email) completed++;
        if(state.perfil.rol) completed++;
        if(state.perfil.unidad) completed++;
      }
      
      // FODA section
      total += 4;
      ['fortalezas','debilidades','oportunidades','amenazas'].forEach(k => {
        if(state.diagnostico[k]) completed++;
      });
      
      // Priorities
      total += 1;
      if(state.prioridades.ranking && state.prioridades.ranking.length) completed++;
      
      // Initiatives
      total += 2;
      if(state.iniciativas.some(i => i.titulo && i.titulo.trim())) completed++;
      if(state.iniciativas.some(i => i.descripcion && i.descripcion.trim())) completed++;
      
      // KPIs
      total += 1;
      if(state.kpis.some(k => k.nombre && k.nombre.trim())) completed++;
      
      // Consent
      total += 1;
      if(state.feedback.consentimiento) completed++;
      
      const percentage = Math.min(100, Math.round((completed / Math.max(1, total)) * 100));
      progressBar.style.width = percentage + '%';
      progressText.textContent = percentage + '% completado';
    }

    function escapeHtml(str){
      const div = document.createElement('div');
      div.textContent = str || '';
      return div.innerHTML;
    }

    function num(x){
      const n = Number(x);
      return isFinite(n) ? n : 0;
    }

    function uid(){
      return Math.random().toString(36).substring(2, 9);
    }

    // Export/Import functionality
    exportBtn.addEventListener('click', doExport);
    finalExport.addEventListener('click', () => {
      if(!state.feedback.consentimiento){
        if(!confirm('No ha marcado el consentimiento. ¿Desea exportar de todos modos?')){
          return;
        }
      }
      doExport();
    });

    function doExport(){
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `plan_desarrollo_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    importInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;
      
      try {
        const text = await file.text();
        const imported = JSON.parse(text);
        state = migrate(imported);
        saveState();
        
        // Refresh all views
        goTo(stepIdx);
        alert('✓ Datos importados correctamente');
      } catch(err) {
        alert('Error al importar el archivo. Verifique que sea un JSON válido.');
      } finally {
        e.target.value = '';
      }
    });

    printBtn.addEventListener('click', () => {
      window.print();
    });

    resetBtn.addEventListener('click', () => {
      if(!confirm('¿Está seguro de reiniciar el formulario? Se perderán todos los datos guardados.')){
        return;
      }
      
      if(!confirm('Esta acción no se puede deshacer. ¿Continuar?')){
        return;
      }
      
      localStorage.removeItem(STORAGE_KEY);
      state = structuredClone(initialState);
      saveState();
      goTo(0);
    });

    // Initialize form fields
    document.querySelectorAll('[data-path]').forEach(input => {
      const value = getByPath(state, input.dataset.path);
      setInputValue(input, value);
    });

    // Initialize
    renderStepper();
    updateProgress();
    goTo(0);

  })();
  </script>
</body>
</html>